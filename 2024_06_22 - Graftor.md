<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3c7d6fad-bc11-4bbc-bef8-a5548df2ab36" width="700" height="400"></p>

<p align="center"> ⚠️ WORK IN PROGRESS ⚠️</p>

# Background - Graftor 

- [Nathan Toporek of InfoBlox](https://blogs.infoblox.com/threat-intelligence/cyber-campaign-briefs/graftor-adware-still-circulating/) (2021) writes:
```
"... past versions of Graftor were capable of browser hijacking, injecting advertising banners, installing other unwanted applications, changing a user’s homepage and search provider, and launching other adware. They also had anti-detection capabilities such as antivirus and sandbox detection".

- Historically, Graftor was delivered via phishing email with an attachment that exploits `CVE-2017-11882`, which is a remote code execution flaw found in Microsoft Office's Equation Editor. 
```

- Kaspersky (2023) writes:
```
"CVE-2017-11882 is a RCE vulnerability in the equation editor from the Microsoft Office and it is associated with a failure to handle objects in RAM. To exploit the vulnerability, an attacker must create a malicious file and somehow convince the victim to open it. Most often, such file is sent by e-mail or is hosted on a compromised site.

Successful exploitation of the CVE-2017-11882 vulnerability allows an attacker to execute arbitrary code with the privileges of the user who opened the malicious file. Thus, if the victim has administrator rights, the attacker will be able to take full control of his system — install programs; view, modify or destroy data; and even create new accounts."
```

- Next, I researched CVE-2017-11882 POCs and found one from Palo Alto's Unit 42. The RTF file they mention is actually hosted on Github by `embedi` at [this link](https://github.com/embedi/CVE-2017-11882/blob/master/example/exploit.rtf).

![Pasted image 20240621125506](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/4b60fc58-0092-43a6-813c-5fe0d65c0be3)


- Above is a screenshot of what the POC looks like. The POC itself is an actual `.rtf` document. `.rtf` documents are typically structured as follows: 

-> Header
- `\rtf1` specifies the RTF version.
- `\ansi` specifies the character set.
- `\ansicpg1252` specifies the code page.
- `\deff0` specifies the default font number.
- `\nouicompat` indicates no user interface compatibility.
- `\deflang1033` specifies the default language.

-> Control Words
- `\b` makes the text bold.
- `\i` makes the text italic.
- `\ul` underlines the text.
- `\par` creates a new paragraph.

-> Groups
- Enclosed in braces, these are used to control words and text together to apply specific formatting.

-> Text
- The actual plain text content of the document.

-> Character Encoding
- I.e. Unicode or ANSI

-> Font Table
- Defines the fonts in the document

-> Color Table
- Defines the colors used in the document.

--- 
# Static Analysis

| Hash Type | File Hash                                                          |
| --------- | ------------------------------------------------------------------ |
| MD5       | `b0f2328750d22b52025015e9ada820a2`                                 |
| SHA1      | `46b0fc8f46a9bda8ee1a85e0002ec1a9e31db223`                         |
| SHA-256   | `1e9f21f514ee4793cfae7baa21549be0d9b432c59513d2efed860c2b1501da39` |

- This particular Graftor sample is in the form of a `.dll`. 
- It has 5 DLL imports:
	- `user32.dll` - Very commonly found in most PEs.
	- `kernel32.dll` - Also very commonly found.
	- `gdi32.dll` - I recognize this from when I analyzed ZBot. This is the Graphics Device Interface DLL which provides a lot of functions for graphical operations involving things like bitmaps.
	- `ws2_32.dll` - This contains a lot of functions related to network communications like sockets, sending and receiving data, and resolving remote hosts.
	- `ntdll.dll` - This is another commonly found DLL. It supports low-level system services like I/O, file system manipulation, token manipulation, etc.

- It exports 3 functions:
	- `gewayX`
	- `gewayZ`
	- `vdaudio`

- There are a few contacted domains, one or more of which might be C2-related.

![Pasted image 20240621133513](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a77b1d5a-cb4b-4b6d-ac14-8e6879a327e1)

- I also see lots of `.tmp` files being dumped to `C:\ProgramData\Microsoft\Windows\WER\Temp\`. 
- It looks like this specific directory is a temporary storage location used by WER to store error report files before they are processed and either sent to Microsoft or discarded ([source](https://answers.microsoft.com/en-us/windows/forum/all/what-is-wer-i-see-the-folder-within-appdata/1bd00574-b17a-e011-9b4b-68b599b31bf5)).

![Pasted image 20240621181816](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/28c380f0-eaea-4ebf-bf4b-bc59f52c052a)

- I also see a lot of `.tmp` files getting deleted. 

![Pasted image 20240621181809](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a130eb0f-73db-4573-bc1e-720197af0efa)

- From what I understand after reading through Microsoft documentation, WER kicks in when unhandled exceptions arise. This appears to be the most common condition when a file gets generated under that directory. 

- Let's extract some strings next. We see a very low string count for static strings, and 1 stack string. 

![Pasted image 20240621182534](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/1c3aa299-e3ea-46a4-a753-8b1066e8e889)

- Several API names can be found. Remember, we only saw 5 APIs in `pestudio`. 

![Pasted image 20240621182619](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/6ce10f8b-2224-4c89-b271-ec4c622855a9)

![Pasted image 20240621182645](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a6dc937f-535f-40fc-9af4-d3e99265e7e0)

- `advapi32` is the only additional DLL in the strings output that was not already previously found. This particular library provides functionalities related to system security, registry, and services management. I wonder how we'll see it used (if at all).

![Pasted image 20240621183037](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/080971c8-d997-448c-b5da-ef8099b5428f)

![Pasted image 20240621183126](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/12517b0c-1955-41f9-88ac-6d2d18373c01)

- Some network-based IOCs as well - nice. We can reference these later.

- Next, let's run `capa` to get an overview of the capabilities of the specimen.
- Right away, `capa` tells us that this specimen is likely packed.

![Pasted image 20240621183344](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/863c37b1-805e-42f4-a004-d59c752257a4)

- That's interesting because `Exeinfo PE` and a few other tools did not detect any packing.

![Pasted image 20240621183513](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ac9fd134-2307-447f-9628-b8dc797ddbab)

- Not sure yet, but we might end up having to use a debugger to manually unpack this sample.

- Taking a look at the `capa` output, we see a `pushad` + `popad` sequence in two functions:

`0x10001C58`

![Pasted image 20240621183928](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/19fb60cf-de54-46e5-8e87-6290c1a34880)

and 

`0x10002974`

![Pasted image 20240621183942](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/0df356e8-8c95-4f65-86a2-4cddfa779148)

- We also see that it uses some type of `receive` function component of `ws2_32` to receive data on a socket at address `0x10003220`.

![Pasted image 20240621184030](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/0c356756-71a3-420e-979e-efb00629ab61)

- Some more indications of TCP-based C2.

![Pasted image 20240621184049](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8bd79a05-9cd4-4acf-ad8e-078eaa736813)

# Dynamic Analysis
## Step 1 - Learning to Debug DLLs

- I have never debugged a `DLL` with `x32dbg` before, so I'll have to do some research.
- `SecurityBreak` Author Thomas Roccia wrote an article on the subject.

![Pasted image 20240624131726](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a5f6e652-da87-4d32-bdc1-27f16a759c8e)

![Pasted image 20240624133855](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/e4350909-e6b7-4540-b2ea-2a69727278bc)

- Once the `DLL` is loaded into `x32dbg`, we have to set a command line to specify the exported function by its ordinal.

![Pasted image 20240624134039](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3be0b38c-29db-4f54-ba69-a18397711e81)

- Then, we have to run it to the Entry Point and begin analyzing.

![Pasted image 20240624134106](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/25ceac93-fa3a-473b-b586-e9b9a4a65575)

- In this case, we have 3 functions to look at.

![Pasted image 20240624133951](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a0ea6f47-d799-4643-937b-38e58cda65a8)

- I followed the instructions in the article. In the below screenshot, we've arrived the Entry Point, and can begin analysis.

![Pasted image 20240624134658](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/faa4c683-5557-4d3d-bad8-d20553afa8d7)

## Function 1 - `gewayx`

- Single stepping through the program, we see some assembly instructions to manipulate registers, the stack, and move data around, etc. 
- Shortly after the entry point, we see the value of `ecx` being moved to `fs:[0]`. `fs:[0]` is a pointer to the first (most recently added) exception handler. At this point, it seems this is a possible indication of SEH abuse. 
- Here is the new exception handler in grey that got added. It doesn't appear to be a custom handler, but rather a specific address in `ntdll.dll`.

![Pasted image 20240624135721](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/b7528705-d8d8-4c24-b1c6-78bf7dc3d290)

- If we continue single-stepping through the user code, it eventually reaches this call to `C71B1A`. If we `Step Over (F8)`, the process terminates.

![Pasted image 20240624142156](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/47c1dc80-7d29-4a9b-96f4-51a102006fa6)

- We need to take a closer look at this function. I suspect it contains anti-analysis code.
- To do this, we'll set a breakpoint there and single-step into it.

![Pasted image 20240624142547](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f052dede-9883-4ea5-8832-74b96d652eda)

- After several function calls, we see the below:

![Pasted image 20240624143112](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/b2a85d93-b4ad-420d-b920-52c38404f3bb)


- Between `003924E0` and `00E9251E`, the code performs the following tasks:

1. Pushes a return address and the previous SEH frame.
2. Sets up the stack and local variables, adjusting the stack pointer.
3. Saves the context of several registers (`ebx`, `esi`, `edi`).
4. Sets up a new SEH frame with XOR operations, possibly as part of an obfuscation or anti-debugging technique.
5. Updates the SEH chain with a new handler.
6. Returns from the function.

- This code appears to be setting up a structured exception handling (SEH) frame, which is often used for managing exceptions or implementing anti-debugging techniques in malware. The usage of XOR operations and manipulation of the SEH frame suggests it could be part of an obfuscation or anti-analysis technique.

- Interesting method for function calls. It moves the address of a the desired API call to a CPU register, and then calls the CPU register. 

- If we keep stepping through, we can eventually figure out how the specimen manages to terminate the process.

![Pasted image 20240624144208](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d3e81d49-ca31-4ed7-85d0-17333daed6a3)

- The code above pushes `1` to the stack and calls `ExitProcess`, causing the process to terminate with Exit Code `1`. This doesn't normally mean anything by itself, but typically an exit code of `0` means that the process completed its execution and exited successfully without any errors.

- Any non-zero codes typically indicate that an error was encountered. 

## Function 2 - `gewayz`

## Function 3- `vdaudio`


# Summary

