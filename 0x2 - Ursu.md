<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/34f03316-3026-49d4-be19-5a3ebe96d2d3" width="400" height="400"></p>

# Static Analysis

| Hash Type | File Hash                                                          |
| --------- | ------------------------------------------------------------------ |
| MD5       | `2A8668A6D0E12C7380A26910D504ECBF`                                 |
| SHA1      | `414300597938D64B3486BE6004003D90D565360D`                         |
| SHA-256   | `CD78CF4AF8E37B4A9DE479867167027887A28527E2738C481A1C6891D707F21A` |

- First, we notice moderate-high entropy in the `.text` section, which might suggest packing.

![Pasted image 20240620063754](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f55d3fb7-e498-4beb-83d7-5297611eaa6c)

- However, `Exeinfo PE` reports that there is no evidence of packing.

![Pasted image 20240620063822](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f32d60cd-499e-4ff3-8466-24a7d49d602e)

- Graphical byte analysis results from `Exeinfo PE` come back normal. Visual distribution does not indicate the entropy patterns we would see with a packed sample.

![Pasted image 20240620063907](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/40136079-2bfe-4e31-b594-9c26c56e87f7)

- This is further confirmed with `bytehist`.

![Pasted image 20240620063938](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/6abaf072-c581-44ab-bea8-5048fa84c022)

![Pasted image 20240620064011](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/4b0c6c2f-f8ba-4132-b3b2-7f80325ac418)

- In PE Studio, we only see 2 imported DLLs
	- `kernel32.dll` - Core Windows system library that provides essential functions for memory management, input/output operations, process and thread creation, and synchronization. Found in almost every PE. 
	- `urlmon.dll` - This library provides functions for handling URLs and internet protocols, primarily used by Internet Explorer and other applications that need to download and manage web content.
 
![Pasted image 20240620064122](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f2201e0d-e2d8-4aac-9a1f-059cbd53d4fb)

- At this point, `urlmon.dll` is the library we will pay close attention to first.

**Important API Calls**

 1. **Execution**
- `CreateProcessA`: Starts a new process.
- `ExitProcess`: Terminates the current process.
- `FreeEnvironmentStringsW`: Frees environment strings.
- `GetCommandLineA`: Retrieves the command-line string.
- `GetCurrentProcess`: Retrieves a pseudo handle for the current process.
- `GetCurrentProcessId`: Retrieves the process identifier of the current process.
- `GetCurrentThreadId`: Retrieves the thread identifier of the calling thread.
- `GetEnvironmentStringsW`: Retrieves environment strings.
- `Sleep`: Suspends the execution of the current thread.
- `TerminateProcess`: Terminates a specified process.

**High-Level Overview:** These functions manage the creation, execution, and termination of processes and threads, as well as handle environment strings and process identifiers.

2. **Synchronization**
- `DeleteCriticalSection`: Deletes a critical section object.
- `EnterCriticalSection`: Waits for ownership of a critical section object.
- `InitializeCriticalSectionAndSpinCount`: Initializes a critical section object with a spin count.
- `LeaveCriticalSection`: Releases ownership of a critical section object.

**High-Level Overview:** These functions manage critical sections, which are used to synchronize access to shared resources in multi-threaded applications.

3. **File Operations**
- `GetFileType`: Retrieves the file type of the specified file.
- `GetSystemTimeAsFileTime`: Retrieves the current system date and time.
- `GetTempFileNameA`: Creates a temporary file name.
- `GetTempPathA`: Retrieves the path of the directory designated for temporary files.
- `WriteFile`: Writes data to a file.

**High-Level Overview:** These functions handle file-related operations such as determining file types, retrieving temporary file paths, and writing data to files.

4. **Memory Management**
- `GetStringTypeW`: Retrieves character type information.
- `HeapAlloc`: Allocates a block of memory from a heap.
- `HeapCreate`: Creates a heap object.
- `HeapFree`: Frees a memory block allocated from a heap.
- `HeapReAlloc`: Reallocates a block of memory from a heap.
- `HeapSetInformation`: Sets information for the specified heap.
- `HeapSize`: Retrieves the size of a memory block allocated from a heap.
- `RtlVirtualUnwind`: Unwinds the stack frame.

**High-Level Overview:** These functions manage memory allocation, deallocation, and reallocation, as well as handle heap management and stack unwinding.

5. **Dynamic Library Management**
- `GetModuleFileNameA`: Retrieves the fully qualified path for the file containing the specified module.
- `GetModuleFileNameW`: Retrieves the fully qualified path for the file containing the specified module.
- `GetModuleHandleW`: Retrieves a module handle for the specified module.
- `GetProcAddress`: Retrieves the address of an exported function or variable.
- `LoadLibraryW`: Loads the specified module into the address space of the calling process.

**High-Level Overview:** These functions manage the loading and handling of dynamic link libraries (DLLs) and the retrieval of function addresses within those libraries.

6. **Reckoning and Timing**
- `GetStartupInfoW`: Retrieves the contents of the STARTUPINFO structure.
- `GetTickCount`: Retrieves the number of milliseconds that have elapsed since the system was started.
- `IsDebuggerPresent`: Determines whether the calling process is being debugged.
- `QueryPerformanceCounter`: Retrieves the current value of the performance counter.

**High-Level Overview:** These functions handle system timing, process startup information, and debugging detection.

7. **Exception Handling**
- `RtlCaptureContext`: Captures the context of the current thread.
- `SetUnhandledExceptionFilter`: Sets a function to be called when an unhandled exception occurs.
- `UnhandledExceptionFilter`: Filters unhandled exceptions.

**High-Level Overview:** These functions manage exception handling by capturing thread contexts and setting filters for unhandled exceptions.

8. **Diagnostic and Error Handling**
- `GetLastError`: Retrieves the calling thread's last-error code.
- `RtlLookupFunctionEntry`: Retrieves the function entry corresponding to a specified address.
- `SetLastError`: Sets the last-error code for the calling thread.

**High-Level Overview:** These functions manage error codes and diagnostic information, helping in debugging and error reporting.

9. **Network Operations**
- **URLDownloadToFileA**: Downloads a file from the Internet to the local machine.

## Attack Plan

We're going to pay close attention to the following:
- Temp file creation(s), file downloads, and file write events
- C2 traffic + network-based indicators such as URLs/IP addresses

## Strings

- What better way to find hardcoded network-based indicators apart from using strings? Let's take a look.

![Pasted image 20240620065648](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/4948f4af-8463-4b20-aa25-7d84a9d69f9d)

- We start by doing some basic string extraction with `Floss` and outputting to a `.txt` file.

![Pasted image 20240620065839](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8ec1863b-a5e2-4379-832e-bea4b5e43833)

- All static strings - no stack strings, decoded strings, etc. That's very convenient. This probably won't be a terribly complicated sample to analyze.

- Once we get past the junk byte patterns in the beginning of the file, there is some possible evidence of context-aware behavior, indicated by the use of `GetActiveWindow` and a quick debugger check, followed by the C2 kickoff. 

![Pasted image 20240620070147](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/0a18f95b-56c0-44c2-ad9f-d1e9584efc30)

- It's also interesting that we see `GetCommandLineA`. Just from the strings output, the context of that call isn't clear, but I suppose it could be used for context-aware behavior. 

- According to to [MSDN](https://learn.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-getcommandlinea), it retrieves the command-line string for the current process and returns it as a `long pointer to (a) string` in memory.

![Pasted image 20240620070354](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f320f046-4fda-4bfa-866d-2b2fc223fef9)

- As we continue to scroll through the `floss` output, we don't see any noteworthy network-based indicators. But I did notice the use of `RtlVirtualUnwind`.

![Pasted image 20240620070822](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/95233a20-3a6f-43b0-8e1c-47aa42ef6f44)

- Apparently this can be used for anti-debugging, obfuscation, evasion, and some other tactics. However, at this point in my malware analysis career, it's outside the scope of my understanding.

## Anti-Debugging Capabilities

- There are a few API calls worth taking a look at here:
	- `GetStartupInfoW`: Retrieves the contents of the STARTUPINFO structure.
	- `GetTickCount`: Retrieves the number of milliseconds that have elapsed since the system was started.
	- `IsDebuggerPresent`: Determines whether the calling process is being debugged.
	- `QueryPerformanceCounter`: Retrieves the current value of the performance counter.


# Dynamic Analysis

- First, I want to take a look at this program with `capa` and get a good understanding of its capabilities. 

- We're going to use the `-vv` switch for a verbose output, which will provide a lot of granular details, including important locations in the program (example below).

![Pasted image 20240620071243](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/457c1b90-452a-4878-b96c-6ea709df3700)

- We can immediately see the addresses where internet file download activity occurs (above), as well as XOR encryption (below).

![Pasted image 20240620071358](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c3adbe28-039c-4bb1-af3f-2e10a5f6b29a)

- As previously seen, there are references to temporary file paths & file names. We'll take a look at disk, system, and file system activity later in our analysis.

![Pasted image 20240620071425](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/0d610eda-07b6-4ae7-a67b-3aed8d07d941)

- We proceed to start up `fakedns`, `inetsim`, and `Wireshark`.

![Pasted image 20240620072852](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a4a9bac8-66b5-4a70-86bb-3d2ca8692cad)

![Pasted image 20240620072859](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/5ce4f18b-8572-4a4f-9ed8-cb9c50110e9d)

![Pasted image 20240620072913](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/fd9a6ee6-d1cc-46f0-aa08-022fe945a433)

- When we trigger an infection with the above programs running, the sample spawns a process under `explorer.exe` as expected, then exits shortly after loading the required DLLs for network comms. 

- Additionally, we see no network-based indicators in Wireshark logs, which means the sample didn't even reach out to anything. 

- There is an alternative option - we can set the default gateway to the IP address of the Remnux machine and trigger another infection without any extra processes running (maybe there is some sort of environment check, or something else). 

- We start an Apache server (`httpd`), turn on `iptables`, and launch Wireshark.'

![Pasted image 20240620074139](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7c217b27-dc56-40ce-a766-55e5d5ea6a46)

- We get a packet capture going, and then re-infect the victim machine, and *boom* - this is what we were looking for.

![Pasted image 20240620074220](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3cbdef5a-b81d-4604-a978-580aace51d2a)

- We see some TCP traffic with an external IP - `1.234.27[.]146`. 

- Let's pull up `Maxmind` (shout out to Chad Tilbury for recommending this tool in the SANS GCFE course).

![Pasted image 20240620074421](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/002c599b-4476-4e00-b17e-30ec64659b37)

- Looks like a broadband IP in South Korea. That's definitely not normal background traffic. 

- VirusTotal shows this IP address is known for having relationships with a bunch of malicious PEs. 

![Pasted image 20240620075549](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/1608ecee-9703-497e-a2f9-cf8570f7df78)

- Taking a closer look at the malware samples that are known to communicate with it, the most commonly found signatures are generic trojans - mostly droppers & downloaders. 

![Pasted image 20240620075655](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/e59c3d3a-856b-49c1-8727-d91d8500e957)

- The next thing we need to do is follow the TCP stream.

![Pasted image 20240620074526](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/adfea34e-621b-433b-9dd1-122bbef3d9bf)

- The TCP flow starts with a GET request for what looks like a PE file named `pcfix.exe` with a pretty obvious `affid` (affiliate ID) parameter.

- This was followed by a generic 404 response from the server. 

- If you're not familiar with how malware affiliates work, here's a snippet from [SafeGuardCyber](https://www.safeguardcyber.com/blog/security/how-affiliates-use-ransomware-as-a-service):

![Pasted image 20240620074750](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8744b62d-4c38-425c-a35d-cdd25d3e68ca)

- At this point, if we want to, we could turn on `OpenVPN` and send a `curl` request to grab a copy of `pcfix.exe` but I'd be shocked if that file is still available from that public IP address.

- Out of curiosity, I gave it a go with `urlscan.io`, to no avail.

![Pasted image 20240620075035](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/46f1f635-8733-4790-a136-196466c64981)

- The JSON output mentions something about a temporary redirect due to `HttpsUpgrades`. 
  
- Well, once those threat actors finally finish that upgrade, we can all go and grab a fresh up-to-date copy üëç

## Analysis of Execution Flow

- Going back to the victim machine, we can see that the process doesn't stick around for long (it should be at the bottom under `explorer.exe`. 
  
- This particular sample closely matches the characteristics of a simple `dropper`. 

![Pasted image 20240620075328](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/547d3b2b-d132-4227-b1ec-a534b861d947)

- I want to take a look at this sample in Ghidra and x64dbg next. 
   
- I'm going to take a look at the most crucial API calls as well as behavior related to internet connectivity (I want to try and understand how the TA enabled it to communicate with the foreign IP address without hardcoding the IP in the program). 

- Let's start by importing it into Ghidra and letting Ghidra analyze & decompile it for a few minutes.

![Pasted image 20240620080006](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a4cd4a06-90a2-4367-aa5a-a6e157676d80)

- Next, we check out `Symbol References` for the location of the call to `URLDownloadToFileA`.

![Pasted image 20240620080947](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/066ab9e4-d219-4bc1-8df4-3c85b464435d)

- According the MSDN, `URLDownloadToFile` takes "A pointer to a string value that contains the URL to download."

![Pasted image 20240620080922](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/aeca6fb6-7741-47a7-a9f0-7b012de18e30)

- The API call is contained in the function `FUN_140001000`.

![Pasted image 20240620081412](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/cf37ac5a-e2f5-48e5-9a90-d2bca4083586)

- Let's take a closer look at that function and try to figure out what it does.

- At first glance, it looks pretty simple:
	1. Checks for a debugger
	2. If a debugger is found, it jumps to another location, changes around some registers and flags, and then eventually exits the program.
	3. If a debugger is not found, it continues with execution.

![Pasted image 20240620081656](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/153b91de-0723-4684-8744-96b1fd8f2233)

![Pasted image 20240620082348](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/38bf07d6-6c8b-4ae0-ba46-97841089c67b)

![Pasted image 20240620082604](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d3e7eded-999a-4cd5-89ae-5c6ae10d1832)

- Eventually, the program triggers a fatal exit.

![Pasted image 20240620082941](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c4577b8a-04e1-4975-a882-32baf646c86e)

- After that, it vanishes. üò∂‚Äçüå´Ô∏è

![Pasted image 20240620083017](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/99f9f9bf-ed3a-4b72-937d-edb0b2773281)

- I still want to understand the communication with the IP address a little better, so this time, I'll restart the debugger with the `ScyllaHide` plugin.

![Pasted image 20240620083139](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/90fe766f-2731-4c7f-bcd9-f9574d2b8e98)

- I'll also set a Breakpoint on the call to `IsDebuggerPresent`.

![Pasted image 20240620083250](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/87d249e5-a7d2-44a2-8564-0d2c9d1641b5)

![Pasted image 20240620083237](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/aa3be541-d5de-40d1-9a63-6fea8f2941b2)

- With the `ScyllaHide` plugin active this time, we have successfully skipped the `jne` instruction.

![Pasted image 20240620084132](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/2c0c1be3-04ea-49f9-91e7-3ffc16a3f421)

![Pasted image 20240620084214](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/30f7b532-b363-409a-a131-c1a2d48dde64)

![Pasted image 20240620084228](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a6e4f863-95b7-49eb-b526-ac5a77053f05)

- Finally got it. The program uses a simple XOR de-obfuscation loop with the key `0x83` to de-obfuscate the URL string stored in memory.

![Pasted image 20240620084616](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/36701e52-42bc-40ad-99a1-ed56604a8e20)

- Next, it does the same thing with the same thing with the Affiliate ID. 

![Pasted image 20240620084801](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/222d6408-24b9-46ec-b67f-00de6b9b509b)

- It then prepares to drop the downloadable PE file under `%UserProfile%\AppData\Local\Temp`

![Pasted image 20240620084925](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/340419dc-8fe7-4597-a82e-435e48a0f8b8)

- It also assigns it a temporary file name - in this case, `BrB505C.tmp`

![Pasted image 20240620085011](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/29b82ffd-7271-4853-9d3b-fbaabb4532cf)

# Reversing

- The `main` function makes a call to `FUN_1400015A4`, which makes a call to the function that performs most of the important work.

![Pasted image 20240703184851](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7d08f6bf-1d84-43c1-9dd1-e6ea85e4b889)

- Stepping into `FUN_1400015a4`, we see a call the function that is responsible for most of the main features of this specimen.

![Pasted image 20240703184945](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f6b4fa35-99e5-4fb1-b6fe-d7853b43e79a)

![Pasted image 20240703184954](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7f940844-48a9-4883-bb15-1b3a931a1222)

- When `FUN_14001c5c` is invoked, the parameter passed is the return value of the function which performs a debugger check and drops the file (named appropriately in the screenshot above). 

- The function `debugger_check_&_file_dropper` does the following:
	- Performs a simple debugger check with `IsDebuggerPresent`
		- If no debugger is found, it initializes variables and performs XOR operations on some data in memory with key `0x83` and copies one of the results to a variable, which it passes to `UrlDownloadToFileA` as the URL parameter. This is a basic obfuscation technique that basically prevents the hardcoded URI from being detected during static analysis (i.e. string extraction). 
	- The downloaded file gets placed in the temp folder with its own randomly generated temp file name with a `BrB` prefix. This exact pattern was observed during the dynamic analysis phase earlier.

# Summary

- This Ursu sample is a dropper that downloads a second-stage PE file from a remote server (providing an affiliate ID as a URI parameter), stores it in the user's `/Temp/` folder as a .tmp file, and then launches it before exiting. 
