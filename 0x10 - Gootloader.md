<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/fb1a4216-4704-47d8-b752-0097cb2b0b24" width="400" height="400"></p>

# Background - Gootloader

- Gootloader is a well-known malware campaign that leverages SEO to deliver malicious JavaScript files to end users. 

- The threat actors are known for creating fake forum websites or for compromising existing forum websites and then inserting download links in comments and replies to entice users to download malicious templates and forms. 

- [Kroll](https://www.kroll.com/-/media/kroll-images/insights/deep-dive-gootloader-malware-infection-chain-figure-1.svg?h=80%25&w=80%25&hash=BF03E7E230EDC3DFF5C844E29C195599) does a great job of breaking down a common attack sequence here:

![Pasted image 20240705131555](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7d686c29-00fd-43fe-bfc2-ae37287c773c)

- Interestingly, I have personally investigated many Gootloader infections in the wild, where users of organizations were searching the internet for document templates related to their job roles, and inadvertently became infected. 

- If sensitive data can be successful exfiltrated in large quantities, it is not uncommon to see it being posted for sale on the dark web. Here's an example of what that looks like - the screenshot shows a post on the famous underground forum `BreachForums`.

![Pasted image 20240705131858](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3d290455-92c1-482d-ad5d-794e80c0079b)

# Analysis

- This Gootloader sample arrives as a `.zip` archive containing a `.js` file. This particular sample is huge, with over 2.4k lines of code. 

- At first glance, there appears to be a bunch of generic, non-malicious code. But if we look deeper, there are clearly some suspicious functions with unusual names.

![Pasted image 20240705132132](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/83d2a85e-26f9-4905-ad67-553d7d79fdbf)

- The above pattern is fairly commonplace throughout the script. By searching for functions, we can immediately identify several functions that don't fit into the normal Underscore JS library and might be malicious in nature.

- Due to its size and complexity, this is going to be extremely intensive to manually reverse-engineer on my own. Fortunately, [Mandiant's Github](https://github.com/mandiant/gootloader) hosts a very useful list of Python scripts designed for de-obfuscation of Gootloader samples.

- Let's check them out:

![Pasted image 20240705135453](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c68e8290-45eb-438f-b3f8-1b3b43078c01)

- I'll clone the repository on my Remnux machine and see if these scripts help with analyzing the sample. 

- After cloning the `git` repo and staging the Gootloader sample, here's what our folder ends up looking like:

![Pasted image 20240705141249](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/950e72ca-41bc-452e-9e20-a6c06cfd3b9c)

- Following Mandiant's guidance, we start by running `GootLoaderAutoJsDecode.py` against the sample and it works perfectly. It outputs a decoded script file as well as host-based and network-based IOCs:

![Pasted image 20240705141437](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d8900958-006d-4d96-922c-40c3bebf37fe)

- We now have a list of IOCs to incorporate into detection engineering and threat hunts.

- Next, let's take a look at the fully decoded/de-obfuscated script output.

![Pasted image 20240705141607](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f8a61619-03a9-4ab9-99a5-8da2a1bf18f1)

- Beautiful. This is much easier to read. Let's clean it up next and see what it does with `js-beautify`.

![Pasted image 20240705141919](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/0e69177e-3151-4137-956c-03656b360c71)

- That's much better. Now we can see that the script has a few vital functions. First, it gathers some basic system information, which it compresses and Base64 encodes.

![Pasted image 20240705151239](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/382fac27-9662-4d94-b1fe-fe3f60229edb)

- Then, it pulls a random URL from the embedded list of URLs and makes an HTTP request to it. Inside that HTTP request, it sends the collected data as a cookie.

![Pasted image 20240705151256](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/e2ae058d-9afe-4058-a976-5a20be98b48a)

- It then uses `WScript` to execute a command based on server responses.

![Pasted image 20240705151334](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/03db0163-9015-4b79-b2c5-e74c43c14ff5)

# Summary

- This is a typical Gootloader sample, which establishes persistence by creating a scheduled task named `New Account Acquisition` and sends collected data about the infected machine to the C2 server (chosen randomly from a list of embedded URLs) at `<url>/xmlrpc[.]php`.

- It then executes commands based on server responses, facilitating the rest of the attack sequence.
