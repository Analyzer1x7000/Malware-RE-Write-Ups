<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/34165cdf-e4c0-4f24-bbb4-2c4666958477" width=400 height=400></p>

# Analysis

- This sample comes as a `.doc` file in `OLE2` format. We can see one embedded macro in stream 7 below.

![Pasted image 20240628152837](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ebc08c37-3296-4644-ad45-c5db89cca950)

- The contents of that stream appear to heavily obfuscated, but there is some readable text.

![Pasted image 20240628153733](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/bf0d53c9-7371-4032-a563-262746adb2be)

- Above, we can see a reference to `1Normal.ThisDocument` - `ThisDocument` being the name of the VBA macro we identified earlier.

![Pasted image 20240628153756](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/07e6c93f-7823-4d91-9c53-b8b3f4f2acda)

- Looking at stream 4, we see text like `ThisDocument.AutoOpen`. In VBA, `AutoOpen` is a special macro that automatically executes when a word document is opened - it is very commonly used by malware.

- So at this point, we know that according to stream 4, the macro in stream 7 will automatically execute (as long as macros are enabled). The next thing we need to do is closely analyze stream 7. 

- To start, we'll search for the sample in VirusTotal and see what results we can get back.

![Pasted image 20240628154234](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/03b282c9-8ae5-4ddd-9240-9386520d062b)

- Cyrillic. Russians.. every single time. 

- The sample generates an HTTP GET request to `http://imperialenergy[.]ca/js/bin.exe`. So at this point, it's beginning to look like a dropper. 

![Pasted image 20240628154401](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/9eaf57f3-87dd-47a3-bb77-69072d3c6ae3)

- It looks like the second stage payload gets staged under the Internet Explorer cache folder. 

![Pasted image 20240628154522](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/75ea078b-f331-4441-b1e9-e52a85e5f981)

- Looking at the plaintext contents of the macro, it does a few key things:

- Implements a function named `XORI` which XORs input strings.

![Pasted image 20240628155157](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7f609843-67dd-4213-a4ea-f97dd34b51a5)

- Implements a function named `HexToString` which converts input from hex format to ASCII.

![Pasted image 20240628155237](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8a58c725-5a5f-4509-979f-1fcfcb1687a6)

- Runs multiple `Auto_Open` subroutines which include `GoTo` commands with gibberish text. These are designed to mislead the RE. 

![Pasted image 20240628155320](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d3377b21-270a-4f04-849d-38986e72a645)

- Implements a subroutine that appears to initialize and provide the necessary parameters for network operations:

![Pasted image 20240628181647](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/df5159a5-35ca-45f0-ac3c-7281efe58921)

- Implements an obfuscated function named `VYXQPXIETSZ` which performs the callout to download the second stage:

![Pasted image 20240628181427](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/34c43eac-9b67-4a19-a9e5-61c80fc529e5)

- Fortunately, the obfuscation is not too complicated. The `GoTo` instructions do not fundamentally change the execution flow and the functions are straightforward in their design. 

# Summary
- This sample is a maldoc containing an embedded VBA macro that calls out to `imperialenergy[.]ca` to download and run a `gzip` encoded second stage `bin.exe`. 

- Once downloaded, the second stage gets placed in the Internet Explorer cache folder and executed from there.

- At the time of this writing, the payload was not available for analysis.
