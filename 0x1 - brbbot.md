<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f0234e9f-97a9-472d-b15f-def70f1f7022" width="400" height="400"></p>

# Triage

## Hashes
| Hash Type | File Hash                                                          |
| --------- | ------------------------------------------------------------------ |
| MD5       | `1c7243c8f3586b799a5f9a2e4200aa92`                                 |
| SHA1      | `4db5a8e237937b6d7b435a8506b8584121a7e9e3`                         |
| SHA-256   | `f47060d0f7de5ee651878eb18dd2d24b5003bdb03ef4f49879f448f05034a21e` |

## OSINT & Sandboxes

### VirusTotal
![Pasted image 20240618153911](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/2d1fa8d5-6a28-4569-91b1-93705848ae94)

- The [file sample is recognized](https://www.virustotal.com/gui/file/f47060d0f7de5ee651878eb18dd2d24b5003bdb03ef4f49879f448f05034a21e) as a 64-bit executable with persistence capabilities, which achieves **persistence** via a registry ASEP key.

![Pasted image 20240618154009](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/030c14d2-5969-4d75-95ec-bd3fe06e5154)

![Pasted image 20240618154028](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/eaea41be-a2b7-448b-b416-458fc17f01a5)

- The sample appears to have been written in C++. 
- The sample contains common capabilities such as:
	- Registry modifications (likely for persistence via ASEP key)
	- Interacts with the Winsock 2 API (basic TCP/IP networking capabilities)
	- Communications over HTTP (likely used for C2)
	- At least one persistence mechanism

![Pasted image 20240618154507](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/dfe4ce40-b93d-4d12-9703-0c152b71ba33)

- At this point in the analysis, we can conclude this is likely a simple sample that includes limited C2 functionalities. However, I see no indications of dropper capabilities, for example.

- A high degree of entropy in the `.text` section (`6.35/8`) might suggest packing. This possibility will be further investigated.

![Pasted image 20240618154516](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/437ca3a2-1c79-4e81-af2d-60c18ecab904)

#### VirusTotal | Imports 

[ADVAPI32.dll](https://www.virustotal.com/gui/search/imports%253AADVAPI32.dll)
- [CryptAcquireContextW](https://www.virustotal.com/gui/search/imports%253ACryptAcquireContextW)
- [CryptCreateHash](https://www.virustotal.com/gui/search/imports%253ACryptCreateHash)
- [CryptDecrypt](https://www.virustotal.com/gui/search/imports%253ACryptDecrypt)
- [CryptDeriveKey](https://www.virustotal.com/gui/search/imports%253ACryptDeriveKey)
- [CryptDestroyHash](https://www.virustotal.com/gui/search/imports%253ACryptDestroyHash)
- [CryptDestroyKey](https://www.virustotal.com/gui/search/imports%253ACryptDestroyKey)
- [CryptEncrypt](https://www.virustotal.com/gui/search/imports%253ACryptEncrypt)
- [CryptHashData](https://www.virustotal.com/gui/search/imports%253ACryptHashData)
- [CryptReleaseContext](https://www.virustotal.com/gui/search/imports%253ACryptReleaseContext)
- [RegCloseKey](https://www.virustotal.com/gui/search/imports%253ARegCloseKey)
- [RegDeleteValueA](https://www.virustotal.com/gui/search/imports%253ARegDeleteValueA)
- [RegFlushKey](https://www.virustotal.com/gui/search/imports%253ARegFlushKey)
- [RegOpenKeyExA](https://www.virustotal.com/gui/search/imports%253ARegOpenKeyExA)
- [RegSetValueExA](https://www.virustotal.com/gui/search/imports%253ARegSetValueExA)

[WININET.dll](https://www.virustotal.com/gui/search/imports%253AWININET.dll)
- [HttpOpenRequestA](https://www.virustotal.com/gui/search/imports%253AHttpOpenRequestA)
- [HttpQueryInfoA](https://www.virustotal.com/gui/search/imports%253AHttpQueryInfoA)
- [HttpSendRequestA](https://www.virustotal.com/gui/search/imports%253AHttpSendRequestA)
- [InternetCloseHandle](https://www.virustotal.com/gui/search/imports%253AInternetCloseHandle)
- [InternetConnectA](https://www.virustotal.com/gui/search/imports%253AInternetConnectA)
- [InternetOpenA](https://www.virustotal.com/gui/search/imports%253AInternetOpenA)
- [InternetQueryDataAvailable](https://www.virustotal.com/gui/search/imports%253AInternetQueryDataAvailable)
- [InternetReadFile](https://www.virustotal.com/gui/search/imports%253AInternetReadFile)
- [InternetSetOptionA](https://www.virustotal.com/gui/search/imports%253AInternetSetOptionA)

[WS2_32.dll](https://www.virustotal.com/gui/search/imports%253AWS2_32.dll)
- [gethostbyname](https://www.virustotal.com/gui/search/imports%253Agethostbyname)
- [gethostname](https://www.virustotal.com/gui/search/imports%253Agethostname)
- [inet_ntoa](https://www.virustotal.com/gui/search/imports%253Ainet_ntoa)
- [WSACleanup](https://www.virustotal.com/gui/search/imports%253AWSACleanup)
- [WSAStartup](https://www.virustotal.com/gui/search/imports%253AWSAStartup)

[KERNEL32.dll](https://www.virustotal.com/gui/search/imports%253AKERNEL32.dll)
- [CloseHandle](https://www.virustotal.com/gui/search/imports%253ACloseHandle)
- [CopyFileA](https://www.virustotal.com/gui/search/imports%253ACopyFileA)
- [CreateEventW](https://www.virustotal.com/gui/search/imports%253ACreateEventW)
- [CreateFileA](https://www.virustotal.com/gui/search/imports%253ACreateFileA)
- [CreateFileW](https://www.virustotal.com/gui/search/imports%253ACreateFileW)
- [CreateProcessA](https://www.virustotal.com/gui/search/imports%253ACreateProcessA)
- [DecodePointer](https://www.virustotal.com/gui/search/imports%253ADecodePointer)
- [DeleteCriticalSection](https://www.virustotal.com/gui/search/imports%253ADeleteCriticalSection)
- [DeleteFileA](https://www.virustotal.com/gui/search/imports%253ADeleteFileA)
- [EncodePointer](https://www.virustotal.com/gui/search/imports%253AEncodePointer)
- [EnterCriticalSection](https://www.virustotal.com/gui/search/imports%253AEnterCriticalSection)
- [ExitProcess](https://www.virustotal.com/gui/search/imports%253AExitProcess)
- [FindResourceA](https://www.virustotal.com/gui/search/imports%253AFindResourceA)
- [FlsAlloc](https://www.virustotal.com/gui/search/imports%253AFlsAlloc)
- [FlsFree](https://www.virustotal.com/gui/search/imports%253AFlsFree)
- [FlsGetValue](https://www.virustotal.com/gui/search/imports%253AFlsGetValue)
- [FlsSetValue](https://www.virustotal.com/gui/search/imports%253AFlsSetValue)
- [FlushFileBuffers](https://www.virustotal.com/gui/search/imports%253AFlushFileBuffers)
- [FreeEnvironmentStringsW](https://www.virustotal.com/gui/search/imports%253AFreeEnvironmentStringsW)
- [GetACP](https://www.virustotal.com/gui/search/imports%253AGetACP)
- [GetCommandLineW](https://www.virustotal.com/gui/search/imports%253AGetCommandLineW)
- [GetComputerNameA](https://www.virustotal.com/gui/search/imports%253AGetComputerNameA)
- [GetConsoleCP](https://www.virustotal.com/gui/search/imports%253AGetConsoleCP)
- [GetConsoleMode](https://www.virustotal.com/gui/search/imports%253AGetConsoleMode)
- [GetCPInfo](https://www.virustotal.com/gui/search/imports%253AGetCPInfo)
- [GetCurrentProcess](https://www.virustotal.com/gui/search/imports%253AGetCurrentProcess)
- [GetCurrentProcessId](https://www.virustotal.com/gui/search/imports%253AGetCurrentProcessId)
- [GetCurrentThreadId](https://www.virustotal.com/gui/search/imports%253AGetCurrentThreadId)
- [GetEnvironmentStringsW](https://www.virustotal.com/gui/search/imports%253AGetEnvironmentStringsW)
- [GetEnvironmentVariableA](https://www.virustotal.com/gui/search/imports%253AGetEnvironmentVariableA)
- [GetFileSize](https://www.virustotal.com/gui/search/imports%253AGetFileSize)
- [GetFileType](https://www.virustotal.com/gui/search/imports%253AGetFileType)
- [GetLastError](https://www.virustotal.com/gui/search/imports%253AGetLastError)
- [GetModuleFileNameA](https://www.virustotal.com/gui/search/imports%253AGetModuleFileNameA)
- [GetModuleFileNameW](https://www.virustotal.com/gui/search/imports%253AGetModuleFileNameW)
- [GetModuleHandleA](https://www.virustotal.com/gui/search/imports%253AGetModuleHandleA)
- [GetModuleHandleW](https://www.virustotal.com/gui/search/imports%253AGetModuleHandleW)
- [GetOEMCP](https://www.virustotal.com/gui/search/imports%253AGetOEMCP)
- [GetProcAddress](https://www.virustotal.com/gui/search/imports%253AGetProcAddress)
- [GetProcessHeap](https://www.virustotal.com/gui/search/imports%253AGetProcessHeap)
- [GetStartupInfoW](https://www.virustotal.com/gui/search/imports%253AGetStartupInfoW)
- [GetStdHandle](https://www.virustotal.com/gui/search/imports%253AGetStdHandle)
- [GetStringTypeW](https://www.virustotal.com/gui/search/imports%253AGetStringTypeW)
- [GetSystemDirectoryA](https://www.virustotal.com/gui/search/imports%253AGetSystemDirectoryA)
- [GetSystemTimeAsFileTime](https://www.virustotal.com/gui/search/imports%253AGetSystemTimeAsFileTime)
- [GetSystemWow64DirectoryA](https://www.virustotal.com/gui/search/imports%253AGetSystemWow64DirectoryA)
- [GetTempFileNameA](https://www.virustotal.com/gui/search/imports%253AGetTempFileNameA)
- [GetTempPathA](https://www.virustotal.com/gui/search/imports%253AGetTempPathA)
- [GetTickCount](https://www.virustotal.com/gui/search/imports%253AGetTickCount)
- [GetVersion](https://www.virustotal.com/gui/search/imports%253AGetVersion)
- [HeapAlloc](https://www.virustotal.com/gui/search/imports%253AHeapAlloc)
- [HeapCreate](https://www.virustotal.com/gui/search/imports%253AHeapCreate)
- [HeapFree](https://www.virustotal.com/gui/search/imports%253AHeapFree)
- [HeapReAlloc](https://www.virustotal.com/gui/search/imports%253AHeapReAlloc)
- [HeapSetInformation](https://www.virustotal.com/gui/search/imports%253AHeapSetInformation)
- [HeapSize](https://www.virustotal.com/gui/search/imports%253AHeapSize)
- [InitializeCriticalSectionAndSpinCount](https://www.virustotal.com/gui/search/imports%253AInitializeCriticalSectionAndSpinCount)
- [IsDebuggerPresent](https://www.virustotal.com/gui/search/imports%253AIsDebuggerPresent)
- [IsValidCodePage](https://www.virustotal.com/gui/search/imports%253AIsValidCodePage)
- [LCMapStringW](https://www.virustotal.com/gui/search/imports%253ALCMapStringW)
- [LeaveCriticalSection](https://www.virustotal.com/gui/search/imports%253ALeaveCriticalSection)
- [LoadLibraryW](https://www.virustotal.com/gui/search/imports%253ALoadLibraryW)
- [LoadResource](https://www.virustotal.com/gui/search/imports%253ALoadResource)
- [LockResource](https://www.virustotal.com/gui/search/imports%253ALockResource)
- [MoveFileExA](https://www.virustotal.com/gui/search/imports%253AMoveFileExA)
- [MultiByteToWideChar](https://www.virustotal.com/gui/search/imports%253AMultiByteToWideChar)
- [QueryPerformanceCounter](https://www.virustotal.com/gui/search/imports%253AQueryPerformanceCounter)
- [ReadFile](https://www.virustotal.com/gui/search/imports%253AReadFile)
- [RtlCaptureContext](https://www.virustotal.com/gui/search/imports%253ARtlCaptureContext)
- [RtlLookupFunctionEntry](https://www.virustotal.com/gui/search/imports%253ARtlLookupFunctionEntry)
- [RtlUnwindEx](https://www.virustotal.com/gui/search/imports%253ARtlUnwindEx)
- [RtlVirtualUnwind](https://www.virustotal.com/gui/search/imports%253ARtlVirtualUnwind)
- [SetEvent](https://www.virustotal.com/gui/search/imports%253ASetEvent)
- [SetFilePointer](https://www.virustotal.com/gui/search/imports%253ASetFilePointer)
- [SetHandleCount](https://www.virustotal.com/gui/search/imports%253ASetHandleCount)
- [SetLastError](https://www.virustotal.com/gui/search/imports%253ASetLastError)
- [SetStdHandle](https://www.virustotal.com/gui/search/imports%253ASetStdHandle)
- [SetUnhandledExceptionFilter](https://www.virustotal.com/gui/search/imports%253ASetUnhandledExceptionFilter)
- [SizeofResource](https://www.virustotal.com/gui/search/imports%253ASizeofResource)
- [Sleep](https://www.virustotal.com/gui/search/imports%253ASleep)
- [TerminateProcess](https://www.virustotal.com/gui/search/imports%253ATerminateProcess)
- [UnhandledExceptionFilter](https://www.virustotal.com/gui/search/imports%253AUnhandledExceptionFilter)
- [WaitForSingleObject](https://www.virustotal.com/gui/search/imports%253AWaitForSingleObject)
- [WideCharToMultiByte](https://www.virustotal.com/gui/search/imports%253AWideCharToMultiByte)
- [WriteConsoleW](https://www.virustotal.com/gui/search/imports%253AWriteConsoleW)
- [WriteFile](https://www.virustotal.com/gui/search/imports%253AWriteFile)

[USER32.dll](https://www.virustotal.com/gui/search/imports%253AUSER32.dll)
- [GetDC](https://www.virustotal.com/gui/search/imports%253AGetDC)

#### VirusTotal | Analysis of Imports

Based on the imports from the malware sample, it appears to possess a variety of functionalities, indicating a sophisticated threat. 

`ADVAPI32.dll`
- The usage of `ADVAPI32.dll` functions, such as `CryptAcquireContextW`, `CryptEncrypt`, and `CryptDecrypt`, suggests the malware can perform cryptographic operations, likely for encrypting data or securing communication. 
  
- Registry manipulation capabilities (`RegOpenKeyExA`, `RegSetValueExA`, `RegDeleteValueA`) imply it can alter system settings, possibly for persistence or to disable security features. 

`WININET.dll`
- The `WININET.dll` imports like `HttpOpenRequestA` and `InternetReadFile` indicate the malware can perform internet-based operations, potentially for data exfiltration or command and control communication. 

`WS2_32.dll`
- Functions from `WS2_32.dll` such as `gethostbyname` and `InternetConnectA` further support network communication abilities. 

`KERNEL32.dll` & `USER32.dll`
- Finally, the `KERNEL32.dll` and `USER32.dll` imports show that the malware can perform basic file operations, process manipulation, and potentially interact with the user interface, suggesting it could execute a range of actions on the infected system.

#### VirusTotal | Relations

- There seems to be one major common indicator for C2 traffic: `brb.3dtuts.by/ads.php`.

![Pasted image 20240618155151](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ad02c4fb-a843-4538-90b3-b7752e03fc1e)

- The URL appears to take various arguments:
	- `i=` - Possible stands for "IP" - Denotes the local IP address of the infected machine
	- `c=` - Possibly stands for "computer" - Denotes the hostname of the infected machine
	- `p=` - Possibly stands for "Payload" - Encoded/encrypted data - appears to be the outputs of commands sent over the C2 channel. 

- A sample of encoded data was submitted to a Malware Analysis GPT and it was discovered to be encrypted with XOR key `0x5B` or `91`. 

- Sample decrypted output:
`Idle;System;smss.exe;csrss.exe;csrss.exe;wininit.exe;winlogon.exe;services.exe;lsass.exe;lsm.exe;...`

- This appears to be a list of running processes. This may be confirmed with further analysis.

![Pasted image 20240618175506](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a92efe9a-6485-45b4-b078-5738fae5c4c6)

- The IPv6 address `1::2` is unroutable and at first glance, its purpose is not clear.

- The presence of the `/wsman` endpoint suggests the malware may be leveraging the `WS-Man` protocol to manage or control remote systems. 

- This protocol is often used for tasks like executing commands, managing system settings, or querying system information remotely.

### Cape Sandbox | Dropped File(s) & Mutexes

![Pasted image 20240618175950](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/830967fd-e567-426a-a7a7-107591c28eda)

- Cape Sandbox results reference a dropped `.tmp` file and 4 mutexes.

![Pasted image 20240618180015](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d99bcff7-6040-4ac3-83cd-30182caac890)

### Cape Sandbox | File Interactions

![Pasted image 20240618180125](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f4d5c8e3-dbf7-4488-a4d2-0b08d63f4d4f)

- From the Cape Sandbox results, we also see interactions with two files (both of which are also potentially deleted):
	- `C:\Users\<user>\AppData\Local\Temp\software.exe`
	- `C:\Users\<user>\AppData\Local\Temp\brbconfig.tmp`

- There are interactions with multiple `DLLs` and `.mui` files that will require further investigation:

![Pasted image 20240618180310](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/6db6bb18-15f2-4747-8014-00de90b41897)

- `winnsi.dll` - This DLL is used by various network-related components and applications to retrieve and manage network information such as network interfaces, IP addresses, and connection statuses.

- `urlmon.dll` - This DLL facilitates the downloading of web content, handling MIME types, and managing security zones in Internet Explorer. It also supports ActiveX and OLE (Object Linking and Embedding) components.

- `srvcli.dll` - This DLL provides APIs for network file and print services, allowing clients to access shared resources on a network server. It's essential for network operations and resource sharing in a Windows network environment.

- `netutils.dll` - This DLL includes helper functions for network operations, such as network configuration, authentication, and domain-related tasks. It is often used in conjunction with other networking DLLs to perform these tasks.

- `mswsock.dll.mui` - This DLL is responsible for implementing Windows Sockets (Winsock) service providers. This includes support for network communication protocols and functionalities. The MUI file allows the `mswsock.dll` to support multiple languages.

- `wshqos.dll` - This DLL helps manage network traffic by prioritizing certain types of traffic over others. It is used to ensure that high-priority network packets (like those used for video conferencing or VoIP) are delivered with minimal delay and jitter.

- `wshqos.dll.mui` - This file contains language-specific resources and support for the wshqos.dll. It allows the main DLL to provide QoS functionalities in various languages, improving the user experience for non-English speakers.

### Cape Sandbox | ASEP Key(s)

- The sample presumably achieves persistence with a simple `Run` registry key:

![Pasted image 20240618180713](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7e814b2a-8832-4520-9940-cf1b02bb5d3f)

# Static Analysis

- I began by using my custom tool [Pointman](https://github.com/Analyzer1x7000/Pointman/blob/main/Pointman.py) to confirm that the file sample I had was a 64-bit PE file.

![Pasted image 20240618182213](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/6be8ac89-e9d4-4ad5-91a3-e2151bd2a0f2)
![Pasted image 20240618182324](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a9967940-587d-48fe-9769-af6275002556)

- Emulating execution with `capa`, we can see the following:

![Pasted image 20240618182901](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/cdd1c240-3fd8-451e-ba4f-16f3f0c9146f)
![Pasted image 20240618182923](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c267d18d-0cc8-4b49-b9ce-a0accb08723d)
![Pasted image 20240618182932](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/960742e7-0b8f-4eae-928b-98955c5370e3)

- As suspected, the sample appears to contain basic C2 and encryption/decryption capabilities. 
- Given that the `brbconfig.tmp` file is not human-readable, and we found XOR-encoded C2 URI parameters, I suspect XOR is involved.

## Evidence of Packing

- `ExeInfo PE` reports that this sample is not packed.

![Pasted image 20240618183101](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/027aba29-ecf9-4932-b07a-d1bf4d97b8f3)

- To further confirm that this sample was not packed, we can take a look at `PE Studio` > `Sections (File)`. If it was packed, we should expect to see sections such as `NPX0` or `UPX0`. 
- In this case, we see no such sections, which makes me feel certain that this sample is not packed.

![Pasted image 20240618212133](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ba341ca6-45d7-497b-bfc7-1110b8fa391b)

## Strings

- Extracting strings with Floss reveals the Registry `run` key along with a Mozilla user-agent and some network indicators.

![Pasted image 20240618183419](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ad0b5774-1d00-4763-942b-634ae10e1b21)
![Pasted image 20240618183355](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/bc419c0b-3c11-4ab7-9b60-0c547b404e48)

## Anti-Debugging Capabilities

- There are two API calls to `IsDebuggerPresent` as shown below.

![Pasted image 20240618212206](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/15cac17d-a4e3-42cc-ba41-e5af10197a35)
1st Call: `00007FF7A4564098`

2nd Call: `00007FF7A45642B5`

**Analyzing the First Call to `IsDebuggerPresent`**

![Pasted image 20240618212326](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/53a09188-693b-4d85-a14e-32712d8ef4ac)

- The above execution flow stores the return value of `IsDebuggerPresent` in `eax` (1 if Debugger = True, 0 if Debugger = False)

- If the program is running in a Debugger, it jumps to address `00007FF7A4568A48`, after which it exits the function (`ret`), jumping to `00007FFEE80B1FE4`.

- It then calls `RtlExitUserThread` to end the current thread, after which it calls `RtlGetSuiteMask`, which is used to determine which Windows product suites are installed on the system.

- The result is a `dw` (double word). Some example return values are shown below:

![Pasted image 20240618212722](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f239e56f-01c6-4f8e-af69-3b23b867af04)

**Analyzing the Second Call to `IsDebuggerPresent`**

- The second call to `IsDebuggerPresent` (`00007FF7A45642B5`) triggers an unhandled exception if a debugger is found.

![Pasted image 20240618213303](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/20948d26-1313-43b1-85ff-654b7c67fe56)

- The above code snippet sets up an exception handler, performs several conditional checks, calls various subroutines based on these conditions, manipulates the stack and registers, and finally, it prepares to terminate the process.

# Dynamic Analysis

![Pasted image 20240618181209](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/7326c093-6c69-479d-b48b-403adcdc2aa9)

- `brbbot.exe` was placed in `C:\Users\AppData\Roaming\` and its process was spawned from `explorer.exe` as a result of double-clicking it in File Explorer.

- It did not spawn any child processes.

![Pasted image 20240618181224](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/785850ac-30f5-416b-9a11-2fe09c71eaa3)

- The `brbconfig.tmp` file discovered earlier was found under `C:\Users\<user>\AppData\Roaming` as expected.

## Analysis of Execution Sequence

- Upon launching, the `brbbot.exe` process loaded the required DLLs and initiated C2.

![Pasted image 20240618181738](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/acbebb41-d2c0-434d-bc34-a428fc1ff3f7)

- Of particular interest (as an indication of C2 activity), `wininet.dll` was heavily referenced.

![Pasted image 20240618181846](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/fe271144-d689-41c3-8b15-6c752152ce5b)


## Analysis of `brbconfig.tmp` Configuration File

- To analyze the `brbconfig.tmp` file, we have to first transfer the file from the Windows VM to the Remnux VM.

![Pasted image 20240618184357](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/dab3cffe-a26f-45c1-8314-6379cae33954)

- I transferred the `brbconfig.tmp` file using WinSCP.

- TrID could not identify the file type.

![Pasted image 20240618184656](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/57908189-e437-412d-b202-b800e7da3542)

![Pasted image 20240618184647](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d9fb3b13-2874-438b-9906-0873f5b704ea)

- The next step in understanding `brbconfig.tmp` will be to manually debug `brbbot.exe` and set a breakpoint at the corresponding API call that is used to decrypt and read the file.

- We start by setting a breakpoint at the `ReadFile` API call.

![Pasted image 20240618185033](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/56db82e9-948b-4b9e-88ba-77fd0ff94d6f)

- MSDN shows that the `ReadFile` API call requires a handle to an open file.

![Pasted image 20240618185255](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c50c62f4-4f09-47d9-9230-1ecd28419962)

- At the breakpoint, the `rcx` register will hold this handle (`100` in this case)

![Pasted image 20240618185307](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/9623df89-5028-4747-85c4-062972db98ea)

- We can validate this by visiting the Handles tab, right-clicking, and hitting "Refresh".

![Pasted image 20240618185429](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/59c6a5b0-214d-45fd-8d77-4f60e7e23cfb)

- We then proceed to `Run to User Code` and look for the call to the `CryptDecrypt` API.

![Pasted image 20240618185540](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/b063a258-6b91-404e-a586-d6b5a283565b)

- We set a breakpoint right after this call, and review the results stored in the `rsp` register:

![Pasted image 20240618185626](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/31a8cce5-d587-45fe-9c41-da67cd64e398)


## Experimenting with C2 Functionality

- Running FakeDNS and INetSim, we can create an `ads.php` file which stores arbitrary data that matches the C2 pattern of the `brbbot.exe` sample. 

- We confirm connectivity by manually retrieving the C2 URL.

![Pasted image 20240618185841](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3c3afcce-86de-4ee4-aa7d-d4c967735a27)

- We can double-check that the sample is communicating over the C2 channel as expected.

![Pasted image 20240618190328](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d7f25c4b-2501-4558-bcfd-1e9499a08a0c)

# In-Depth Reversing

![Pasted image 20240703153444](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8be8548b-c05f-4597-840b-374a940337f0)

- The specimen begins by retrieving a handle to itself and identifying its own file name.

![Pasted image 20240703153638](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f7ca9e57-46f5-445d-9d75-7d0f0b8c2a10)

- After gathering basic host, user, and file system information, it proceeds to extract the `CONFIG` resource from its own `.rsrc` section and copy its contents to a new `brbconfig.tmp` file under the `temp` folder and create a registry run key for persistence.

![Pasted image 20240703153812](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/cd5385eb-ce8d-40f7-b3cb-8fa66f733994)

![Pasted image 20240703153825](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/45b91ed0-af97-4a04-8906-8bd642fd69db)

![Pasted image 20240703153941](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/491ab78e-52b4-451f-a0b8-60c606c6f221)

- It proceeds to use `CryptDecrypt` to read the contents of the XOR-encrypted config file.

![Pasted image 20240703154052](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/82471ee5-7346-4663-86b7-a13aa431dbc0)

- Lastly, it proceeds to kick off the C2 process by sending out an `HTTP GET` request over port 80 with `HttpSendRequestA`.

![Pasted image 20240703154156](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f99b9583-2913-4d38-b6df-e37a77422603)


# Summary

- This `brbbot` sample contains basic C2 and anti-debugging functionalities. 

- The sample first performs a simple check for the presence of debuggers > if `brbbot.exe` is found to be running in the context of a debugger, it will terminate the process. 
- Otherwise, the sample will write an XOR-encrypted `config` file to disk named `brbconfig.tmp` and establish persistence via a registry `Run` key. 
- It will then proceed to check in with the C2 server at `3d.tuts.by` to receive commands hosted in the contents of `/ads.php`.
- It will match the contents of the `ads.php` file to its own config file on disk to execute basic commands, including `exec, file, conf, & exit`.
