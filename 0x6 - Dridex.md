<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/b2539f58-6fd8-4126-ac52-882f41ec3855" width=675f height=400></p>

# Background - Dridex Malware

**The Members**

- [Check Point](https://blog.checkpoint.com/security/march-2020s-most-wanted-malware-dridex-banking-trojan-ranks-on-top-malware-list-for-first-time/) (2020) wrote that their "Global Threat Index for March 2020 shows the well-known banking trojan Dridex, which first appeared in 2011, has entered the top ten malware list for the first time, as the third most prevalent malware in March."

- Similar to ZBot and its many variants, Dridex has historically been a banking trojan. CrowdStrike associates Dridex primarily with `Evil Corp`, led by Maksim Yakubets (Максим Якубец), who is known for showing off his lavish lifestyle on social media (i.e. Instagram).

![Pasted image 20240627100511](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/18375dca-6abd-42cf-a907-8b0c6f2512c5)

- As a 90's kid myself, I noticed that he bears a striking resemblance to the late and great Jimmy Neutron. 

- Here is picture that more people are familiar with depicting another member of `Evil Corp`, Andrey Plotniskiy holding a stack of cash earned from ransomware campaigns.

![Pasted image 20240627100653](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8dfb3252-54e8-4c8a-9486-09971e18c654)

- The members are known for driving different expensive luxury vehicles like Lamborghinis, Audi R8s, Skyline GT-Rs, and Mercedes G-Wagons. Additionally, they are known to use custom vanity plates with the characters `вор`. In Russian, `вор` translates to `thief`.

![Pasted image 20240627101301](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/e926cc70-fb80-4b1e-9312-2361a0a9d735)

![Pasted image 20240627101327](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/6cde2fec-b74d-4632-9a15-42c14a401778)

- The above images are courtesy of [Curtis from riskint.blog](https://www.riskint.blog/post/tracking-evil-corp-s-cars) .

- In my ZBot analysis, I mentioned Evgeniy Bogachev, the author of the Zeus banking trojan. As it turns out, he is close friends with Maksim's crew. Russians of a feather tend to flock together.

![Pasted image 20240627101857](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/48588db0-e2da-4a96-9d36-29db959ea79e)

- Since at least 2017, Yakubets has been actively working in coordination with the Russian FSB and as of 2018, he was in the process of "obtaining a license [security clearance] to work with Russian classified information from the FSB." (source: [treasury.gov](https://home.treasury.gov/news/press-releases/sm845))

**Technical Details**

- Unsurprisingly, Dridex is known to be delivered via phishing email containing a fake invoice with an attached `.xlsm` downloader which launches a macro that uses `URLDownloadToFileA` to download the stage 2 (primary) payload.

- From there, the infection kicks off and the specimen initiates C2 and data exfil.

- Interestingly, the primary payload is known to use a technique where it registers a VEH handler which gets called when the CPU raises an exception in response to `int3` (`noop` or `no operation`) instructions. This VEH handler gets registered via `AddVectoredExceptionHandler`. 

- `int3` is not expressly used to trigger an exception, but rather, the author(s) are known to intentionally use `_debugbreak()` (a built-in command) that works exactly the same as using an `int3` instruction. 

- Authors Oleg Boyarchuk, Jason Zhang, and Giovanni Vigna did a [fantastic write-up](https://blogs.vmware.com/security/2021/03/analysis-of-a-new-dridex-campaign.html) on this where they explained that you can make the debugging process much easier by changing exception settings to not pause on `int3` instructions.

- Dridex v4 emerged in February 2017 and it used a new technique for code injection ("AtomBombing") according to [HHS](https://www.aha.org/system/files/media/file/2020/06/hc3-cyber-threat-briefing-tlp-white-dridex%20malware-6-25-2020.pdf): '

![Pasted image 20240627122634](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/631f761b-716c-426d-bc4e-3d5f6e5367c1)

# Hands-On With a Dridex Dropper

- This sample comes as a `.doc` in `OLE2` format with 3 embedded macros.

![Pasted image 20240627123321](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/113d963e-6d71-477a-9fe0-1c212208e467)

![Pasted image 20240627123401](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f03738b7-f7ad-4184-810c-d0381590eb8f)

- Let's start by extracting stream 9.

![Pasted image 20240627123547](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/41ee46a1-1931-451b-9113-9b5963187034)

- We can immediately see some suspicious Powershell. Let's also check out streams 10 & 11.

![Pasted image 20240627123539](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/a5476d8f-29b5-48d6-b6f1-4a767331e36d)

- The embedded Powershell from stream 9 references `UserForm1` and `ControlTipText`. From what we can see here, it kind of looks like it's referencing `UserForm` in the context of `CheckBox1`. 
- The term `ControlTipText` is a property that can be used in UserForms (custom dialogue boxes) and ActiveX controls to display a tooltip when a user hovers over something.

![Pasted image 20240627124046](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ffa0a658-5c73-47f2-a904-8e527ebaee82)

- Let's try to figure out where `CheckBox1` appears.

![Pasted image 20240627124400](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c65ee481-2ebf-4984-821f-7f397da57b06)

- It appears right here under stream 7 and it looks like a big base64 encoded blob. Let's decode it with `CyberChef`.

- First, we'll have to extract it with `base64dump.py`. 

![Pasted image 20240627124506](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/9ffea2c6-e942-4ac0-9f78-92ed68dcd195)

- Just like I thought. Look at the "Decoded" column - there is some Powershell in there. Next, we can use `base64dump.py` to extract that specific string and analyze it further.

![Pasted image 20240627124632](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/ed6f6913-0705-48ca-8ffa-08af21a75a09)

- The null terminators after every character probably indicates `UTF-16` formatting. Unfortunately, this happens a lot when extracting Powershell scripts from specimens. However, it can easily be cleaned up.

![Pasted image 20240627125359](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/9e25ebd3-486d-4904-99cc-63e7507fa2c4)

- The base64-decoded Powershell script has its own base64 encoded blob which is also `gzip` compressed. The script decodes, decompresses it, and then executes it. 
- So, naturally, the next step will be to decode and decompress this next base64 blob.

- Here's what it looks like after base64 decoding: 

![Pasted image 20240627125141](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/76d7bf79-c9c6-4b32-b63e-317d68332638)

- And here's what it looks like after base64 decoding and `gzip` decompression:

![Pasted image 20240627125216](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3ed4f52e-43bd-4fc7-82fb-ed0bfa467745)

- Let's output this new dump to its own separate file and analyze it.

![Pasted image 20240627125346](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/43e874bb-543c-4696-b1b5-83304c003159)

- The script above is a typical example of how Powershell can be used to execute malicious payloads. It uses in-memory execution, obfuscation, and process compatibility handling. 

- It starts by setting strict mode to version 2, which enforces certain rules and restrictions on how the script should be run. In strict mode, any attempt to use a variable that has not been initialized will throw an error. The same will happen when attempting to access properties, non-existent members, etc. 

- The base64 payload assigned to `$var_code` in the middle is likely shellcode. It gets base64-decoded on line 24 and then `XOR` decrypted with the key `0x35` on lines 26-27. 

- On line 30, the script resolves the address of `kernel32.dll` -> `VirtualAlloc` and then injects and then the script injects and executes the shellcode on lines 34-35. 

- So, we next need to base64 decode the shellcode and then `XOR` decrypt it just like the Powershell script would.

- The decoded & decrypted shellcode, as expected, is not in human-readable format.

![Pasted image 20240627130408](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/01534193-8e52-4ba6-af01-8103f3d85450)

- We can run `Floss` against it, however, to pull out some strings.

![Pasted image 20240627130543](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c49c36e7-d191-434b-80ea-58b680e48d28)

- `Floss` returns 19 static strings, 1 stack string, and 1 decoded string. 
- It managed to pull out an HTTP user-agent and an IP address. That's a great start.

![Pasted image 20240627130635](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/91375de0-1dbd-4684-867c-51c47365760d)

- Doesn't look like a very friendly IP address. It's been spotted in relation to CobaltStrike and some other bad activity.

![Pasted image 20240627130724](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/b0bc99a0-0924-4ac3-b682-ed9aa5e9fa85)

- There are also some nasty files associated with it.

![Pasted image 20240627130759](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c80929c6-d2ca-4149-8824-961ac1583cb9)

- The next thing we can do is emulate the shellcode with a tool like `scdbgc` to assess its capabilities.

- Here's a good find - we see an HTTPS request via `InternetConnectA` to `172.98.192[.]91` with a pre-specified user-agent. 

![Pasted image 20240628150805](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/e22af3cb-41cc-42fe-af69-74c5a63f72fa)

# Summary

- This sample is a malicious word doc that contains embedded VBA macros that use Powershell to execute shellcode on the system.

- The shellcode appears to contain basic dropper functionality, presumably downloading one or more payloads.






