<p align="center"><img src="https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/10480bff-84d9-4534-b902-660bfdf48d1d" width="550" height="400"></p>

<p align="center">⚠️ WORK IN PROGRESS ⚠️</p>

# Background - WannaCry

- WannaCry, perhaps the most famous malware of all time, first emerged in May 2017 and targeted Windows operating systems. 

- According to most open source intel, it was largely spread using EternalBlue, the famous SMB exploit developed by the NSA and leaked by the Shadow Brokers. 

- Side note: TryHackMe has a [room](https://tryhackme.com/r/room/blue) where users can practice exploiting EternalBlue - I highly recommend it.

- Three major versions of WannaCry are known to have been developed, all of which were written in C++. 

- It is estimated that approximately 51.6 BTC (worth $2.9 billion at the time of this writing) was transferred to the threat actor's bitcoin wallet between May 12 and June 14, 2017.

- John Leyden of The Register wrote, "Flashpoint concludes that the unidentified [perpetrators] - without speculating on their nationality - are likely to be Chinese speaker," judging by in-depth linguistic analysis of the ransom note. 

- [Some of the major victims](https://www.ibtimes.co.uk/wannacry-list-major-companies-networks-hit-by-deadly-ransomware-around-globe-1621587) of WannaCry include the UK's NHS (National Health Service), Telefonica, Deutsche Bahn (German national railway company), FedEx, Nissan, the Russian Central Bank, and the Russian Interior Ministry. 

# Analysis

- PE Studio reports an overall entropy of 7.966 (extremely high) as well as multiple suspicious indicators.

![Pasted image 20240705215539](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/4a1442dd-622c-4b3d-bd1b-1824f250d747)

- The PE file comes with a resource named `2058` which constitutes 90+% of the overall file. If that's not suspicious, I don't know what is.

- Among the included libraries are lots of normal DLLs we would expect to see in most malware samples, but we can also see some outliers like `iphlpapi.dll`.

- `iphlpapi.dll` is the IP Helper API which contains functionalities related to things such as network configuration management, network statistics functions, ARP and routing, DNS configurations, and TCP/IP configurations. 
	- [Link to MS Documentation](https://learn.microsoft.com/en-us/windows/win32/api/iphlpapi/)

- Let's pull out some strings next.

![Pasted image 20240705220236](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/f25ce93c-cd84-44c8-9bb3-887490fb092f)

- Scrolling down, we see some references to what appears to be the Adler-32 checksum compression library as well as a reference to Gilles Vollant's unzip API.

![Pasted image 20240705221304](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/251ac21b-84be-4e9c-bcc5-144bb1dbaaff)

- Remember that huge resource section named `2058`? We also see the API calls that we would expect for resource extraction not much farther down, which makes me inclined to hypothesize that the sample will probably extract and use that resource section early on in its execution flow.

![Pasted image 20240705221343](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/c31479d0-1869-4e17-a74a-0ff393ccb5a3)

- We also see the usual API calls for cryptography functions (common with ransomware) as well as some host-based indicators that indicate the use of scheduled tasks and mutex(es).

- The command `icacls . /grant Everyone:F /T /C /Q` in Windows quietly grants full control by all users to a directory recursively.

- We also see what looks like references to multiple different messages boxes in different languages. This makes me think there might be a function to check the system language (`LangID`) value and display the appropriate message box accordingly.

![Pasted image 20240705221742](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/55db2542-7130-4fc8-9fbc-47e25a8f1bd7)

![Pasted image 20240705221753](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/cab4f501-983c-4f6a-af2e-947ae6546984)

![Pasted image 20240705221802](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/38c6e56d-0ef6-47c7-ba7a-e53059578f9c)

- Most of what see is gibberish until we reach the `UTF-16LE Strings` section, where we see operating system identifiers and IPC share references that include RFC1918 IP addresses, along with the usual file extensions.

![Pasted image 20240705222105](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/01369cca-a45b-4924-afe8-0e6bc2120ab2)

- `Software\` makes me wonder if there is some registry modification going on, such as a Registry run key for persistence.

- We also see some file paths with `%s`, which looks to be a wildcard of some kind.

![Pasted image 20240705222157](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/3969b92e-7922-46cc-a602-37d9d0e74205)

- Lastly, there are some stack strings with some generic data.

![Pasted image 20240705222238](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/1e872c09-0aa2-4907-92d3-d226f4154ab4)

- Next, we'll emulate its execution with `capa`. 

![Pasted image 20240705222437](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/1284206b-f3b2-46a8-bf95-429b243b2672)

- I'm curious about that resource we saw. We can throw the sample into `x32dbg` and see what happens just before the call to `LoadResource`. 

![Pasted image 20240705222437](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/44d7500f-766d-48d9-9ecb-f00b022b797a)

- Looking at the instructions we see that `LoadResource` gets called with `hModule` parameter `0x0` and `hResInfo` `710080`. This means the resource that's being targeted is a resource inside the PE itself and  `710080` represents the handle to that resource.

- If we scroll back a bit, we can also see the call to `FindResourceA`, where it pushes the resource name/identifier `0x43137c` to the stack, which identifies our suspicious PE section.

![Pasted image 20240705224045](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/38b90033-b0e6-48c7-a919-c093449806bc)

- Let's go into Ghidra next and analyze some of the core mechanics of this specimen.

- I'm renaming the first function that gets called from `main()` to `kickoff`, as it essentially kicks off the infection. 

- The `kickoff` function starts by generating a randomized computer identifier based on the hostname and a mathematical algorithm. 

![Pasted image 20240708112451](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/8acaea0f-82e8-4436-ab1c-b8eb161207ac)

![Pasted image 20240708112504](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/d59410a6-2a28-4848-aec6-13e39d66219c)

- Next, it proceeds to check for a Windows directory. If it exists, it creates a nested folder inside. 

- If that Windows directory cannot be found, it attempts to create a nested folder in the `temp` directory.

![Pasted image 20240708112645](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/b9f09d09-7ebb-464d-a5d0-a0f413e9b895)

- `FUN_00401dab` is where the fun starts - this function appears to be responsible for extracting the resource embedded inside the original PE file.

- Line 20 shows the method it uses to locate the `2058` resource:

![Pasted image 20240708113455](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/4da2687b-7c6d-4a93-bd6b-48026717d93d)

- Once the `2058` resource is extracted, it writes it to the file `C:\Windows\tasksche.exe` where it can then be executed.

![Pasted image 20240708112805](https://github.com/Analyzer1x7000/Malware-RE-Write-Ups/assets/103800652/97c8d937-c444-45d5-ae98-07d8ead4c8c6)
